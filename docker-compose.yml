services:
  dogatto-app:
    image: dogatto_dev
    build:
      context: .
      dockerfile: docker/clails/Dockerfile
    container_name: dogatto_app
    volumes:
      - ./:/app
    ports:
      - ${PORT:-5000}:${PORT:-5000}
      - ${SWANK_PORT:-4005}:${SWANK_PORT:-4005}
    tty: true
    command: ["/app/docker/run-dev.sh"]
    environment:
      CLAILS_HOME: "/app"
      BIND_ADDRESS: "${BIND_ADDRESS:-0.0.0.0}"
      PORT: "${PORT:-5000}"
      SWANK_ADDRESS: "${SWANK_ADDRESS:-0.0.0.0}"
      SWANK_PORT: "${SWANK_PORT:-4005}"
      CLAILS_DB_HOST: "${CLAILS_DB_HOST:-mysql}"
      CLAILS_DB_PORT: "${CLAILS_DB_PORT:-3306}"
      CLAILS_DB_USERNAME: "${CLAILS_DB_USERNAME:-dogatto}"
      CLAILS_DB_PASSWORD: "${CLAILS_DB_PASSWORD:-password}"
      CLAILS_DB_NAME: "${CLAILS_DB_NAME:-dogatto_development}"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      VITE_DEV_SERVER_URL: "${VITE_DEV_SERVER_URL:-http://localhost:3000}"
    networks:
      - dogatto-net
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-5000}/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  mysql:
    image: mysql:8.0
    container_name: dogatto_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${CLAILS_DB_USERNAME:-dogatto}
      MYSQL_PASSWORD: ${CLAILS_DB_PASSWORD:-password}
      MYSQL_DATABASE: ${CLAILS_DB_NAME:-dogatto_development}
    ports:
      - ${MYSQL_PORT:-3306}:3306
    volumes:
      - dogatto-mysql-data:/var/lib/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./db/init:/docker-entrypoint-initdb.d:ro
    networks:
      - dogatto-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: dogatto_redis
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - ${REDIS_PORT:-6379}:6379
    volumes:
      - dogatto-redis-data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - dogatto-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

networks:
  dogatto-net:
    driver: bridge

volumes:
  dogatto-mysql-data:
  dogatto-redis-data:
