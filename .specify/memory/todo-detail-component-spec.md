# TODO詳細表示コンポーネント仕様

## 概要

TODOの詳細情報を表示するコンポーネント。完了状態に応じて異なるアクションを提供する。内容はMarkdown形式でレンダリングされる。

## 使用場所

- ホーム画面のTODO一覧からタイトルクリック時
- TODO詳細画面 (`/todos/{ulid}`)
- モーダル表示またはページ遷移

## 表示モード

### 1. モーダル表示モード

**特徴:**
- ホーム画面からのクイックプレビュー
- 背景オーバーレイ
- 閉じるボタン（×）
- Escapeキーで閉じる

### 2. ページ表示モード

**特徴:**
- 専用URL (`/todos/{ulid}`)
- ブックマーク可能
- 直接アクセス可能
- 共有リンク対応

## 表示項目

### 2.1 ヘッダー部

**表示内容:**
```
+--------------------------------------------------+
| No: 01ARZ3NDEKTSV4RRFFQ69G5FAV          [DONE] × |
+--------------------------------------------------+
```

**要素:**
- No（ULID）
  - ラベル: "No:"
  - 値: TODO の ULID
  - スタイル: 小さめのグレー文字
  - コピー可能（クリックでクリップボードにコピー）
  - ツールチップ: "クリックでコピー"

- 完了状態バッジ（完了時のみ表示）
  - テキスト: "DONE" / "完了"
  - スタイル: 緑色のバッジ
  - 位置: 右上

- 閉じるボタン（モーダルモードのみ）
  - アイコン: × 
  - 位置: 右上端
  - クリックでモーダルを閉じる

### 2.2 本体部

**レイアウト:**
```
+--------------------------------------------------+
| 体重測定                                          |
| [DAILY] [HEALTH]                                 |
+--------------------------------------------------+
| 📅 期限: 2026-01-15                              |
+--------------------------------------------------+
| 毎朝の体重を記録する                              |
|                                                  |
| ## チェックリスト                                 |
| - [ ] 体重計に乗る                               |
| - [ ] 記録する                                   |
+--------------------------------------------------+
```

### 2.3 件名

**表示仕様:**
- フォントサイズ: 大（24px / 1.5rem）
- フォントウェイト: Bold
- 色: プライマリテキスト色
- 折り返し: 複数行対応
- 最大表示: 制限なし

### 2.4 タグ一覧

**表示仕様:**
- 配置: 件名の下
- 形式: バッジ表示
- スタイル:
  - 背景色: タグの設定色
  - テキスト: 白色（または背景色に応じた色）
  - パディング: 4px 8px
  - ボーダーラジアス: 4px
  - マージン: 4px
- インタラクション:
  - ホバー時: 背景色を濃く
  - クリック時: 該当タグでフィルタリング（ホーム画面へ遷移）

### 2.5 期限

**表示仕様:**
- アイコン: 📅 カレンダーアイコン
- ラベル: "期限:" / "Due:"
- 形式: YYYY-MM-DD または "YYYY年MM月DD日"
- 色:
  - 通常: グレー
  - 当日: オレンジ
  - 期限切れ: 赤
  - 完了済み: グレー
- 期限なしの場合: 表示しない

**相対日付表示:**
- 今日: "今日"
- 明日: "明日"
- 昨日: "昨日（期限切れ）"
- それ以外: "N日後" または "N日前（期限切れ）"

### 2.6 内容（本文）

**表示仕様:**
- Markdown形式でレンダリング
- サポートする構文:
  - 見出し (H1-H6)
  - 段落
  - リスト（順序付き・順序なし）
  - チェックリスト
  - リンク
  - 太字・斜体
  - コードブロック・インラインコード
  - 引用
  - 水平線
  - テーブル（オプション）
  - 画像（将来対応）

**セキュリティ:**
- HTMLタグのサニタイズ
- XSS対策
- スクリプト実行の防止

**スタイル:**
- フォントサイズ: 通常（16px / 1rem）
- 行間: 1.6
- 段落間マージン: 16px
- リンク色: プライマリ色
- コードブロック: 背景色付き

**空の場合:**
- 表示: "（内容なし）" / "(No description)"
- スタイル: グレーイタリック

### 2.7 メタ情報（フッター部）

**表示内容:**
```
+--------------------------------------------------+
| 作成日時: 2026-01-10 10:30                       |
| 更新日時: 2026-01-11 08:15                       |
| 完了日時: 2026-01-11 08:20  ※完了時のみ          |
+--------------------------------------------------+
```

**表示仕様:**
- フォントサイズ: 小（12px / 0.75rem）
- 色: グレー
- 形式: YYYY-MM-DD HH:MM
- 配置: 左寄せ

## アクション

### 3.1 未完了TODO（status: active）のアクション

**アクションボタン配置:**
```
+--------------------------------------------------+
|                              [完了] [編集] [削除] |
+--------------------------------------------------+
```

#### 3.1.1 完了ボタン

**表示:**
- テキスト: "完了" / "Done" または "✓ 完了"
- スタイル: プライマリボタン
- 位置: 右端

**動作:**
1. クリック時: 確認ダイアログ表示（オプション）
2. API呼び出し: `PATCH /api/todos/{ulid}/complete`
3. 成功時:
   - トースト通知: "TODOを完了しました"
   - 完了状態に更新
   - アクションボタンを非表示
   - 完了バッジを表示
   - 完了日時を表示
4. 失敗時:
   - エラーダイアログ表示

**キーボードショートカット:**
- `d` または `D`: 完了

#### 3.1.2 編集ボタン

**表示:**
- テキスト: "編集" / "Edit" または "✏️ 編集"
- スタイル: セカンダリボタン
- 位置: 右から2番目

**動作:**
1. クリック時: TODO登録・編集コンポーネントを編集モードで開く
2. 現在の値をフォームに設定
3. モーダルモードの場合: 詳細表示を閉じて編集フォームを開く
4. ページモードの場合: 編集フォームへ遷移

**キーボードショートカット:**
- `e` または `E`: 編集

#### 3.1.3 削除ボタン

**表示:**
- テキスト: "削除" / "Delete" または "🗑️ 削除"
- スタイル: デンジャーボタン（赤色）
- 位置: 右から3番目

**動作:**
1. クリック時: 削除確認ダイアログ表示
   - メッセージ: "このTODOを削除してもよろしいですか？"
   - サブメッセージ: "削除したTODOは復元できません。"
   - ボタン: "削除", "キャンセル"
2. 削除確定時:
   - API呼び出し: `DELETE /api/todos/{ulid}`
3. 成功時:
   - トースト通知: "TODOを削除しました"
   - モーダルを閉じる
   - ホーム画面の一覧から削除
4. 失敗時:
   - エラーダイアログ表示

**キーボードショートカット:**
- `Delete` または `Backspace`: 削除（確認ダイアログ表示）

### 3.2 完了TODO（status: completed）のアクション

**アクションボタン配置:**
```
+--------------------------------------------------+
|                         [未完了に戻す] [削除]     |
+--------------------------------------------------+
```

#### 3.2.1 未完了に戻すボタン

**表示:**
- テキスト: "未完了に戻す" / "Reopen" または "↩️ 未完了に戻す"
- スタイル: セカンダリボタン
- 位置: 右端

**動作:**
1. クリック時: API呼び出し: `PATCH /api/todos/{ulid}/reopen`
2. 成功時:
   - トースト通知: "TODOを未完了に戻しました"
   - 未完了状態に更新
   - 完了バッジを非表示
   - 完了日時を非表示
   - アクションボタンを未完了用に変更
3. 失敗時:
   - エラーダイアログ表示

**キーボードショートカット:**
- `r` または `R`: 未完了に戻す

#### 3.2.2 削除ボタン

**表示・動作:**
- 未完了時の削除ボタンと同じ

**注意:**
- 完了済みTODOの編集は不可（未完了に戻してから編集）

## API仕様

### 4.1 TODO詳細取得

**エンドポイント:** `GET /api/todos/{ulid}`

**パスパラメータ:**
- `ulid`: TODO の ULID

**レスポンス (成功):**
```json
{
  "status": "success",
  "data": {
    "todo": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "title": "体重測定",
      "description": "毎朝の体重を記録する\n\n## チェックリスト\n- [ ] 体重計に乗る\n- [ ] 記録する",
      "status": "active",
      "due_date": "2026-01-15",
      "tags": [
        {
          "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
          "name": "DAILY",
          "color": "#3B82F6"
        },
        {
          "ulid": "01BRZ3NDEKTSV4RRFFQ69G5FAV",
          "name": "HEALTH",
          "color": "#10B981"
        }
      ],
      "is_shared": false,
      "created_at": "2026-01-10T10:30:00Z",
      "updated_at": "2026-01-11T08:15:00Z",
      "completed_at": null
    }
  }
}
```

**レスポンス (完了済み):**
```json
{
  "status": "success",
  "data": {
    "todo": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "title": "体重測定",
      "description": "毎朝の体重を記録する",
      "status": "completed",
      "due_date": "2026-01-15",
      "tags": [...],
      "is_shared": false,
      "created_at": "2026-01-10T10:30:00Z",
      "updated_at": "2026-01-11T08:20:00Z",
      "completed_at": "2026-01-11T08:20:00Z"
    }
  }
}
```

**ステータスコード:**
- 200: 成功
- 401: 認証エラー
- 403: アクセス権限なし（他ユーザーのTODO）
- 404: TODOが見つからない
- 500: サーバーエラー

### 4.2 TODO完了

**エンドポイント:** `PATCH /api/todos/{ulid}/complete`

**レスポンス (成功):**
```json
{
  "status": "success",
  "data": {
    "todo": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "status": "completed",
      "completed_at": "2026-01-11T08:20:00Z",
      "updated_at": "2026-01-11T08:20:00Z"
    }
  }
}
```

### 4.3 TODO未完了に戻す

**エンドポイント:** `PATCH /api/todos/{ulid}/reopen`

**レスポンス (成功):**
```json
{
  "status": "success",
  "data": {
    "todo": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "status": "active",
      "completed_at": null,
      "updated_at": "2026-01-11T08:25:00Z"
    }
  }
}
```

### 4.4 TODO削除

**エンドポイント:** `DELETE /api/todos/{ulid}`

**レスポンス (成功):**
```json
{
  "status": "success",
  "message": "TODOを削除しました"
}
```

**ステータスコード:**
- 200: 削除成功
- 401: 認証エラー
- 403: アクセス権限なし
- 404: TODOが見つからない
- 500: サーバーエラー

## Markdownレンダリング仕様

### 5.1 使用ライブラリ

**推奨:**
- marked.js
- markdown-it
- react-markdown (React使用時)

### 5.2 セキュリティ設定

**サニタイズ:**
- DOMPurify使用
- HTMLタグのホワイトリスト
- スクリプトタグの除去
- イベントハンドラの除去

**設定例（marked.js）:**
```javascript
import marked from 'marked';
import DOMPurify from 'dompurify';

const renderer = new marked.Renderer();

// リンクを新しいタブで開く
renderer.link = (href, title, text) => {
  return `<a href="${href}" title="${title || ''}" target="_blank" rel="noopener noreferrer">${text}</a>`;
};

const markdown = marked(content, {
  renderer: renderer,
  breaks: true,
  gfm: true
});

const sanitized = DOMPurify.sanitize(markdown, {
  ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'a', 'strong', 'em', 'del', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'input'],
  ALLOWED_ATTR: ['href', 'title', 'target', 'rel', 'type', 'checked', 'disabled']
});
```

### 5.3 チェックリスト対応

**Markdown記法:**
```markdown
- [ ] 未完了タスク
- [x] 完了タスク
```

**レンダリング結果:**
```html
<ul>
  <li><input type="checkbox" disabled> 未完了タスク</li>
  <li><input type="checkbox" checked disabled> 完了タスク</li>
</ul>
```

**スタイル:**
- チェックボックス: 表示のみ（クリック不可）
- 完了タスク: 打ち消し線

**将来の拡張:**
- チェックリストの進捗表示
- チェックボックスのインタラクティブ対応

### 5.4 コードブロック

**シンタックスハイライト:**
- highlight.js
- prism.js

**対応言語:**
- JavaScript
- Python
- Java
- Go
- SQL
- その他主要言語

## UI/UX要件

### 6.1 レスポンシブデザイン

**デスクトップ（1024px以上）:**
- モーダル幅: 800px
- 最大高さ: 90vh
- スクロール: コンテンツエリアのみ

**タブレット（768px - 1023px）:**
- モーダル幅: 95%
- 最大高さ: 90vh

**モバイル（767px以下）:**
- フルスクリーン表示
- ヘッダー固定
- アクションボタン: フローティング表示

### 6.2 アクセシビリティ

**キーボード操作:**
- `Escape`: モーダルを閉じる
- `e`: 編集
- `d`: 完了
- `r`: 未完了に戻す
- `Delete`: 削除

**ARIA属性:**
- `role="dialog"`: モーダル
- `aria-labelledby`: タイトル
- `aria-describedby`: 内容
- `aria-live`: 状態変更の通知

**スクリーンリーダー対応:**
- 完了状態の読み上げ
- 期限の読み上げ
- アクション実行結果の通知

### 6.3 パフォーマンス

**レンダリング:**
- Markdownの事前パース（キャッシュ）
- 遅延レンダリング（長文の場合）
- 画像の遅延読み込み（将来対応）

**API呼び出し:**
- TODO取得: 初回のみ
- 状態変更後の再取得は不要（楽観的更新）

### 6.4 アニメーション

**モーダル表示:**
- フェードイン（200ms）
- スライドアップ（オプション）

**状態変更:**
- 完了時: チェックアニメーション
- 削除時: フェードアウト

**ローディング:**
- スケルトンスクリーン表示

## エラーハンドリング

### 7.1 TODO取得エラー

**404エラー:**
- メッセージ: "TODOが見つかりませんでした"
- アクション: ホーム画面へ戻るボタン

**403エラー:**
- メッセージ: "このTODOにアクセスする権限がありません"
- アクション: ホーム画面へ戻るボタン

**ネットワークエラー:**
- メッセージ: "通信エラーが発生しました"
- アクション: 再読み込みボタン

### 7.2 操作エラー

**完了/未完了エラー:**
- トースト通知でエラー表示
- リトライボタン

**削除エラー:**
- エラーダイアログ表示
- リトライボタン

## データモデル（再掲）

### 8.1 TODOsテーブル

```sql
CREATE TABLE todos (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  ulid CHAR(26) UNIQUE NOT NULL,
  user_id BIGINT NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  status ENUM('active', 'completed', 'archived') DEFAULT 'active',
  due_date DATE,
  completed_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_ulid (ulid),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_due_date (due_date)
);
```

## 実装順序

### フェーズ1: 基本表示
1. レイアウト作成
2. TODO情報の表示
3. タグ表示
4. メタ情報表示

### フェーズ2: Markdownレンダリング
1. Markdownライブラリ統合
2. サニタイズ処理
3. チェックリスト対応
4. コードブロック対応

### フェーズ3: アクション実装
1. 完了ボタン
2. 編集ボタン
3. 削除ボタン
4. 未完了に戻すボタン

### フェーズ4: UX改善
1. キーボードショートカット
2. レスポンシブデザイン
3. アニメーション
4. エラーハンドリング

## テスト要件

### 9.1 単体テスト
- Markdownレンダリング
- サニタイズ処理
- 日付表示フォーマット
- 状態判定ロジック

### 9.2 統合テスト
- TODO取得API連携
- 完了API連携
- 削除API連携
- 未完了に戻すAPI連携

### 9.3 E2Eテスト
- TODO詳細表示フロー
- 完了フロー
- 編集フロー
- 削除フロー
- 未完了に戻すフロー
- キーボード操作

### 9.4 セキュリティテスト
- XSS攻撃の防止
- HTMLインジェクションの防止
- スクリプト実行の防止

## 将来の拡張

- TODO履歴表示
- コメント機能
- 添付ファイル表示
- 共有設定管理
- サブタスク機能
- リマインダー設定
- 印刷機能
- エクスポート機能（Markdown, PDF）
- チェックリストのインタラクティブ操作
- 画像プレビュー
- リッチテキストエディタ統合

## 関連仕様

- ホーム画面仕様: `home-spec.md`
- TODO登録・編集コンポーネント仕様: `todo-form-component-spec.md`
- タグ管理画面仕様: `tags-spec.md` (今後作成)

---

**Version**: 1.0.0
**Created**: 2026-01-11
**Last Updated**: 2026-01-11
