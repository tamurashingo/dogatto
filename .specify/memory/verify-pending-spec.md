# 本登録待ち画面仕様

## 概要

仮登録状態（メール未認証）のユーザーがログイン後に表示される画面。メール認証完了まで他の機能へのアクセスを制限し、認証メールの再送機能を提供する。

## URL

- エンドポイント: `/verify-pending`
- アクセス制御: 仮登録状態のユーザーのみ

## 表示条件

### 1. 自動遷移

**トリガー:**
- 仮登録状態（`status: pending_verification`）でログイン成功時
- 仮登録状態で他の画面（ホーム画面、TODO詳細など）にアクセス試行時

**遷移元:**
- ログイン画面 (`/login`)
- ユーザー登録画面 (`/signup`) - 登録完了後
- ホーム画面 (`/`)
- TODO詳細画面 (`/todos/{ulid}`)
- その他の認証が必要な画面

**遷移方法:**
- リダイレクト（302 Found または History API）
- URL変更: 遷移元 → `/verify-pending`

### 2. アクセス制御

**許可される画面:**
- 本登録待ち画面 (`/verify-pending`)
- ログアウト処理

**禁止される画面:**
- ホーム画面 (`/`)
- TODO関連画面
- タグ・ラベル管理画面
- プロフィール画面
- その他すべての機能画面

## 画面構成

### レイアウト

```
+--------------------------------------------------+
|                    DOGATTO                        |
+--------------------------------------------------+
|                                                  |
|              📧 メール認証が必要です              |
|                                                  |
|   登録いただいたメールアドレスに確認メールを      |
|   送信しました。メール内のリンクをクリックして     |
|   登録を完了してください。                        |
|                                                  |
|   📩 user@example.com                            |
|                                                  |
|   [確認メールを再送信]                           |
|                                                  |
|   メールが届かない場合:                           |
|   • 迷惑メールフォルダを確認してください          |
|   • メールアドレスが正しいか確認してください      |
|   • 数分お待ちください（送信に時間がかかる場合）  |
|                                                  |
|   [ログアウト]                                   |
|                                                  |
+--------------------------------------------------+
```

### 本登録完了後

```
+--------------------------------------------------+
|                    DOGATTO                        |
+--------------------------------------------------+
|                                                  |
|              ✅ メール認証が完了しました          |
|                                                  |
|   ありがとうございます！                          |
|   登録が完了しました。                            |
|                                                  |
|   [ホーム画面へ]                                 |
|                                                  |
+--------------------------------------------------+
```

## 表示要素

### 1. ヘッダー部

**要素:**
- ロゴ: DOGATTO
- ユーザーメニュー（簡易版）
  - メールアドレス表示
  - ログアウトボタン

### 2. メインコンテンツ

#### 2.1 タイトル

**表示内容:**
- アイコン: 📧 または ✉️
- テキスト: "メール認証が必要です" / "Email Verification Required"
- スタイル: 大きく目立つフォント

#### 2.2 説明文

**表示内容:**
```
登録いただいたメールアドレスに確認メールを送信しました。
メール内のリンクをクリックして登録を完了してください。
```

**スタイル:**
- 中央寄せ
- 読みやすいフォントサイズ
- 行間を広めに

#### 2.3 登録メールアドレス表示

**表示形式:**
- アイコン: 📩
- テキスト: 登録したメールアドレス
- スタイル: 太字、プライマリ色

**取得元:**
- ユーザー情報API: `GET /api/user`

#### 2.4 確認メール再送信ボタン

**表示:**
- テキスト: "確認メールを再送信" / "Resend Verification Email"
- スタイル: プライマリボタン
- 位置: 中央

**動作:**
1. クリック時: 確認メール再送信API呼び出し
2. 成功時:
   - ボタンを無効化（60秒間）
   - カウントダウン表示: "再送信可能まで 59秒"
   - トースト通知: "確認メールを再送信しました"
3. 失敗時:
   - エラーダイアログ表示
   - エラー内容を表示

**レート制限:**
- 1回/分（60秒）
- 制限中は再送信ボタンを無効化
- カウントダウンタイマー表示

#### 2.5 トラブルシューティング

**表示内容:**
```
メールが届かない場合:
• 迷惑メールフォルダを確認してください
• メールアドレスが正しいか確認してください
• 数分お待ちください（送信に時間がかかる場合があります）
```

**スタイル:**
- 小さめのフォント
- グレー色
- リスト形式

#### 2.6 ログアウトボタン

**表示:**
- テキスト: "ログアウト" / "Logout"
- スタイル: セカンダリボタンまたはテキストリンク
- 位置: 中央または右下

**動作:**
1. クリック時: ログアウト処理実行
2. トークンをクリア
3. ログイン画面へリダイレクト

### 3. 本登録完了時の表示

#### 3.1 完了メッセージ

**表示内容:**
- アイコン: ✅
- タイトル: "メール認証が完了しました" / "Email Verified!"
- メッセージ: "ありがとうございます！登録が完了しました。"

**スタイル:**
- 成功を示す色（緑）
- 大きなフォント
- アニメーション（フェードイン、スケールアップ）

#### 3.2 ホーム画面へのリンク

**表示:**
- テキスト: "ホーム画面へ" / "Go to Home"
- スタイル: 大きなプライマリボタン
- 位置: 中央

**動作:**
- クリック時: ホーム画面 (`/`) へ遷移

**注意:**
- 自動遷移は行わない（ユーザーが手動でクリック）
- 理由: メール認証画面とホーム画面の両方が開いている状態を防ぐ

## ポーリング処理

### 認証状態の定期確認

**目的:**
- メール認証完了を自動検知
- ユーザーが画面をリロードする必要をなくす

**実装:**
```javascript
// ポーリング設定
const POLLING_INTERVAL = 5000; // 5秒
const MAX_POLLING_COUNT = 720; // 最大1時間（5秒 × 720回）

let pollingCount = 0;
let pollingTimer = null;

async function checkVerificationStatus() {
  try {
    const response = await fetch('/api/user');
    const data = await response.json();
    
    if (data.data.user.status === 'active') {
      // 本登録完了
      clearInterval(pollingTimer);
      showVerifiedMessage();
    }
    
    pollingCount++;
    if (pollingCount >= MAX_POLLING_COUNT) {
      // 1時間経過したらポーリング停止
      clearInterval(pollingTimer);
    }
  } catch (error) {
    console.error('Polling error:', error);
  }
}

// ポーリング開始
pollingTimer = setInterval(checkVerificationStatus, POLLING_INTERVAL);

// ページ離脱時にポーリング停止
window.addEventListener('beforeunload', () => {
  clearInterval(pollingTimer);
});
```

**ポーリング間隔:**
- 5秒〜10秒に1回
- 推奨: 5秒（ユーザー体験を考慮）

**ポーリング停止条件:**
- 本登録完了を検知
- 最大ポーリング回数に到達（1時間後）
- ページから離脱
- ログアウト

**パフォーマンス考慮:**
- API呼び出しは軽量（ユーザー情報のステータスのみ）
- タイムアウト設定（3秒）
- エラー時のリトライ制限

## API仕様

### 1. ユーザー情報取得

**エンドポイント:** `GET /api/user`

**ヘッダー:**
```
Authorization: Bearer {jwt_token}
```

**レスポンス (仮登録状態):**
```json
{
  "status": "success",
  "data": {
    "user": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "email": "user@example.com",
      "username": "user@example.com",
      "status": "pending_verification",
      "created_at": "2026-01-11T00:00:00Z"
    }
  }
}
```

**レスポンス (本登録完了):**
```json
{
  "status": "success",
  "data": {
    "user": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "email": "user@example.com",
      "username": "user@example.com",
      "status": "active",
      "verified_at": "2026-01-11T01:00:00Z",
      "created_at": "2026-01-11T00:00:00Z"
    }
  }
}
```

**ステータスコード:**
- 200: 成功
- 401: 認証エラー
- 500: サーバーエラー

### 2. 確認メール再送信

**エンドポイント:** `POST /api/auth/resend-verification`

**リクエスト:**
```json
{
  "email": "user@example.com"
}
```

**レスポンス (成功):**
```json
{
  "status": "success",
  "message": "確認メールを再送信しました"
}
```

**レスポンス (レート制限):**
```json
{
  "status": "error",
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "確認メールは1分に1回まで送信できます",
    "retry_after": 45
  }
}
```

**ステータスコード:**
- 200: 再送信成功
- 400: バリデーションエラー
- 429: レート制限超過
- 500: サーバーエラー

## セキュリティ要件

### 1. 認証

- JWTトークン必須
- 仮登録状態のユーザーのみアクセス可能
- 本登録完了後は自動的にホーム画面へリダイレクト

### 2. レート制限

**確認メール再送信:**
- 1回/分（60秒）
- IPアドレスベース
- ユーザーIDベース

### 3. CSRF対策

- 確認メール再送信APIにはCSRFトークン必須

### 4. XSS対策

- メールアドレスのエスケープ処理
- ユーザー入力のサニタイズ

## UI/UX要件

### 1. レスポンシブデザイン

**デスクトップ（1024px以上）:**
- 中央寄せレイアウト
- 最大幅: 600px

**タブレット（768px - 1023px）:**
- 中央寄せレイアウト
- 幅: 90%

**モバイル（767px以下）:**
- フルスクリーン
- パディング調整

### 2. アクセシビリティ

**キーボード操作:**
- Tab: ボタン間の移動
- Enter: ボタンのクリック
- Escape: モーダルを閉じる（該当する場合）

**ARIA属性:**
- `role="alert"`: エラーメッセージ
- `aria-live="polite"`: ステータス変更の通知
- `aria-label`: ボタンのラベル

**スクリーンリーダー対応:**
- ポーリング中の状態変更を読み上げ
- 本登録完了時の通知

### 3. ローディング状態

**ポーリング中:**
- 小さなローディングインジケーター（オプション）
- "確認中..." のテキスト表示（オプション）

**再送信中:**
- ボタンにローディングインジケーター
- ボタンテキスト: "送信中..."

### 4. アニメーション

**画面遷移:**
- フェードイン（200ms）

**本登録完了時:**
- 成功アイコンのスケールアップ + 回転（500ms）
- メッセージのフェードイン（300ms）

**再送信完了時:**
- トースト通知のスライドイン

## エラーハンドリング

### 1. ポーリングエラー

**原因:**
- ネットワークエラー
- サーバーエラー
- トークン期限切れ

**対応:**
- エラーをコンソールに記録
- ポーリングは継続（次回で成功する可能性）
- 連続3回失敗したらポーリング停止
- エラーメッセージ表示: "接続エラーが発生しました。ページを再読み込みしてください。"

### 2. 再送信エラー

**原因:**
- ネットワークエラー
- メールサーバーエラー
- レート制限超過

**対応:**
- エラーダイアログまたはトースト通知
- エラーメッセージを表示
- リトライボタン（レート制限以外）

### 3. 認証エラー

**原因:**
- トークン期限切れ
- 無効なトークン

**対応:**
- ログイン画面へリダイレクト
- メッセージ: "セッションが期限切れです。再度ログインしてください。"

## 実装順序

### フェーズ1: 基本画面
1. レイアウト作成
2. メッセージ表示
3. メールアドレス表示
4. ログアウトボタン

### フェーズ2: 再送信機能
1. 確認メール再送信ボタン
2. API連携
3. レート制限表示
4. エラーハンドリング

### フェーズ3: ポーリング機能
1. ユーザー情報ポーリング
2. ステータス変更検知
3. 本登録完了時の表示切り替え

### フェーズ4: UX改善
1. アニメーション追加
2. レスポンシブデザイン
3. アクセシビリティ対応
4. エラーハンドリング強化

## テスト要件

### 1. 単体テスト
- ポーリングロジック
- レート制限カウントダウン
- ステータス変更検知

### 2. 統合テスト
- ユーザー情報API連携
- 確認メール再送信API連携
- 本登録完了後の画面切り替え

### 3. E2Eテスト
- 仮登録状態でログイン
- 本登録待ち画面表示
- 確認メール再送信フロー
- ポーリングによる自動検知
- メール認証後のホーム画面遷移
- 他画面へのアクセス制限

### 4. パフォーマンステスト
- ポーリングのリソース消費
- 長時間ポーリングの動作確認
- 複数タブでの動作確認

## 非機能要件

### 1. パフォーマンス
- ポーリングAPI応答時間: 100ms以内
- ページロード時間: 1秒以内

### 2. 可用性
- システム稼働率: 99.9%以上

### 3. スケーラビリティ
- 同時ポーリング: 1000ユーザー対応

## 将来の拡張

- QRコード表示（モバイル認証用）
- メールアドレス変更機能
- SMS認証オプション
- 認証リンクの有効期限表示
- 認証進捗のビジュアル表示
- WebSocket による即座の通知（ポーリング不要）

## 関連仕様

- ユーザー登録画面仕様: `signup-spec.md`
- ログイン画面仕様: `login-spec.md`
- ホーム画面仕様: `home-spec.md`

---

**Version**: 1.0.0
**Created**: 2026-01-11
**Last Updated**: 2026-01-11
