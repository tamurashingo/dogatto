# DOGATTO 実装計画

## 概要

DOGATTO（タグベースTODO管理アプリ）の実装計画。仕様書に基づき、段階的に機能を実装していく。

## プロジェクト情報

- **プロジェクト名**: DOGATTO
- **技術スタック**:
  - バックエンド: Common Lisp (clails framework) + MySQL + Redis
  - フロントエンド: TypeScript + React + Next.js
  - インフラ: Docker
- **開発期間**: 約3-4ヶ月（想定）
- **計画作成日**: 2026-01-11

## 実装フェーズ

### Phase 0: 環境構築・基盤整備（Week 1-2）

**目的**: 開発環境のセットアップとプロジェクト基盤の整備

#### 0.1 開発環境セットアップ
- [ ] Docker環境の構築
  - MySQL コンテナ
  - Redis コンテナ（セッション管理用）
  - clails アプリケーションコンテナ
  - Next.js 開発サーバーコンテナ
- [ ] docker-compose.yml の作成
- [ ] ローカル開発環境の動作確認

#### 0.2 データベース初期構築
- [ ] データベーススキーマの実装
  - users テーブル
  - todos テーブル
  - todo_comments テーブル
  - tags テーブル
  - todos_tags ジャンクションテーブル
  - labels テーブル
  - labels_tags ジャンクションテーブル
- [ ] ULID生成関数の実装（MySQL関数またはアプリケーション層）
- [ ] マイグレーションスクリプトの作成
- [ ] シードデータの作成（開発用）

#### 0.3 バックエンド基盤
- [ ] clails プロジェクト構造の整理
- [ ] ルーティング設定
- [ ] CORS設定
- [ ] Redis接続設定
- [ ] セッション管理の実装（Redis使用）
- [ ] CSRF対策の実装
- [ ] エラーハンドリング共通処理
  - エラーレスポンス生成関数
  - ログ出力機能
- [ ] バリデーション共通処理
- [ ] ULID生成ユーティリティ

#### 0.4 フロントエンド基盤
- [ ] Next.js プロジェクトセットアップ
- [ ] ディレクトリ構成の整理
- [ ] 共通コンポーネントの骨格
- [ ] API クライアントの実装
  - fetch wrapper
  - エラーハンドリング
  - ApiError クラス
- [ ] 認証状態管理（Context/Store）
- [ ] ルーティング設定

**成果物**:
- 動作する開発環境
- データベーススキーマ
- 基本的なAPI基盤
- フロントエンド骨格

**所要期間**: 2週間

---

### Phase 1: 認証機能（Week 3-4）

**目的**: ユーザー登録・ログイン・メール認証機能の実装

#### 1.1 ユーザー登録機能（Backend）
- [ ] POST /api/auth/signup API
  - メールアドレス・パスワードでの登録
  - バリデーション
  - パスワードハッシュ化
  - 仮登録状態でユーザー作成
  - ULID生成
- [ ] メール送信機能
  - 認証メール送信
  - メールテンプレート
- [ ] メール認証機能
  - GET /api/auth/verify-email/:token
  - トークン検証
  - 本登録状態への更新

#### 1.2 ユーザー登録画面（Frontend）
- [ ] /signup ページ
- [ ] ユーザー登録フォーム
  - メールアドレス入力
  - パスワード入力
  - バリデーション表示
- [ ] GitHub連携ボタン（UI のみ、機能は Phase 2）
- [ ] エラー表示
- [ ] 登録完了後の遷移

#### 1.3 本登録待ち画面（Frontend）
- [ ] /verify-pending ページ
- [ ] 定期的な認証状態チェック（5-10秒間隔）
- [ ] 認証完了後のホーム画面へのリンク表示
- [ ] 確認メール再送機能

#### 1.4 ログイン機能（Backend）
- [ ] POST /api/auth/login API
  - メールアドレス・パスワード認証
  - セッション作成
  - 仮登録状態のチェック
- [ ] POST /api/auth/logout API
- [ ] GET /api/auth/me API（現在のユーザー情報取得）

#### 1.5 ログイン画面（Frontend）
- [ ] /login ページ
- [ ] ログインフォーム
  - メールアドレス入力
  - パスワード入力
- [ ] GitHub連携ボタン（UI のみ）
- [ ] ユーザー登録画面へのリンク
- [ ] エラー表示

#### 1.6 認証ミドルウェア
- [ ] 認証チェックミドルウェア（Backend）
- [ ] メール認証チェックミドルウェア（Backend）
- [ ] 認証ガード（Frontend）
  - ログイン済みチェック
  - 未認証時のリダイレクト

**成果物**:
- ユーザー登録・ログイン機能
- メール認証機能
- 認証状態管理

**所要期間**: 2週間

---

### Phase 2: TODO基本機能（Week 5-7）

**目的**: TODO の CRUD 操作と基本的なタグ機能

#### 2.1 タグ CRUD API（Backend）
- [ ] POST /api/tags（タグ作成）
- [ ] GET /api/tags（タグ一覧取得）
- [ ] GET /api/tags/:ulid（タグ詳細取得）
- [ ] PATCH /api/tags/:ulid（タグ更新）
- [ ] DELETE /api/tags/:ulid（タグ削除）
- [ ] タグ名の大文字変換処理
- [ ] タグの色管理

#### 2.2 TODO CRUD API（Backend）
- [ ] POST /api/todos（TODO作成）
- [ ] GET /api/todos（TODO一覧取得）
  - ページネーション
  - タグフィルタリング（AND条件）
  - ソート機能
- [ ] GET /api/todos/:ulid（TODO詳細取得）
- [ ] PATCH /api/todos/:ulid（TODO更新）
- [ ] DELETE /api/todos/:ulid（TODO削除）
- [ ] POST /api/todos/:ulid/done（TODO完了）
- [ ] タグの紐付け処理
- [ ] Markdown対応

#### 2.3 TODO登録・編集コンポーネント（Frontend）
- [ ] TodoFormコンポーネント
- [ ] 件名入力
- [ ] 内容入力（Markdownエディタ）
- [ ] 期限入力
- [ ] タグ入力
  - タグサジェスト機能
  - キーボード操作（↑↓、Enter）
  - タグバッジ表示・削除
  - 大文字変換
  - IME確定状態チェック
- [ ] バリデーション
- [ ] 保存・キャンセル

#### 2.4 TODO詳細表示コンポーネント（Frontend）
- [ ] TodoDetailコンポーネント
- [ ] 件名・内容表示
- [ ] Markdownレンダリング
- [ ] タグバッジ表示
- [ ] 期限表示
- [ ] アクションボタン
  - DONE
  - 編集
  - 削除

#### 2.5 ホーム画面（Frontend - 基本版）
- [ ] / ページ
- [ ] 未認証時のプロダクト紹介画面
- [ ] 認証済み時のホーム画面
  - TODO一覧表示
  - TODO登録エリア
  - 簡易検索
- [ ] セッションタイムアウト処理

**成果物**:
- TODO CRUD機能
- タグ管理機能
- ホーム画面（基本版）

**所要期間**: 3週間

---

### Phase 3: タグ管理画面（Week 8-9）

**目的**: タグの詳細管理機能

#### 3.1 タグ管理画面（Frontend）
- [ ] /tags ページ
- [ ] タグ一覧表示
  - ソート機能
  - ページネーション
- [ ] タグ検索機能
- [ ] タグ作成モーダル
- [ ] タグ編集モーダル
  - 名称変更
  - 色変更
- [ ] タグ削除機能
  - 確認ダイアログ
  - 使用状況表示

#### 3.2 タグの色管理（Backend/Frontend）
- [ ] カラーピッカーコンポーネント
- [ ] プリセット色の定義
- [ ] タグバッジへの色反映

**成果物**:
- タグ管理画面
- タグの色設定機能

**所要期間**: 2週間

---

### Phase 4: ラベル機能（Week 10-11）

**目的**: 複数タグをまとめるラベル機能

#### 4.1 ラベル CRUD API（Backend）
- [ ] POST /api/labels（ラベル作成）
- [ ] GET /api/labels（ラベル一覧取得）
  - ラベル名検索
  - タグ名検索
  - ページネーション
- [ ] GET /api/labels/:ulid（ラベル詳細取得）
- [ ] PATCH /api/labels/:ulid（ラベル更新）
- [ ] DELETE /api/labels/:ulid（ラベル削除）
- [ ] GET /api/labels/estimate-todo-count（TODO数推定）
- [ ] GET /api/labels/:ulid/usage（使用状況取得）
- [ ] ラベルとタグの紐付け処理

#### 4.2 ラベル管理画面（Frontend）
- [ ] /labels ページ
- [ ] ラベル一覧表示
  - タグバッジ表示
  - TODO数表示
  - ソート・フィルタ
  - ページネーション
- [ ] ラベル作成モーダル
  - タグドロップダウン
  - TODO数推定（リアルタイム）
- [ ] ラベル編集モーダル
  - タグ追加・削除
  - 変更確認ダイアログ
- [ ] ラベル削除機能
- [ ] 検索機能
  - ラベル名検索
  - タグ名検索
  - 検索モード切り替え

#### 4.3 ホーム画面のラベル対応
- [ ] ラベル選択機能
- [ ] ラベルによるTODO絞り込み
- [ ] ラベル表示エリア

**成果物**:
- ラベル管理機能
- ラベルによるTODO検索

**所要期間**: 2週間

---

### Phase 5: マージ機能（Week 12-13）

**目的**: タグ・ラベルのマージ機能

#### 5.1 タグマージ機能（Backend）
- [ ] POST /api/tags/merge API
  - マージ元・マージ先の検証
  - マージ履歴の記録
  - TODOの紐付け更新
  - ラベルの紐付け更新
  - リダイレクト処理

#### 5.2 タグマージ画面（Frontend）
- [ ] /tags/merge ページ
- [ ] マージ元タグ選択
- [ ] マージ先選択
  - 既存タグへのマージ
  - 新規タグ作成
- [ ] 影響確認表示
  - マージ元TODO数
  - マージ先TODO数
- [ ] マージ実行・確認

#### 5.3 ラベルマージ機能（Backend）
- [ ] POST /api/labels/merge API
  - マージ元・マージ先の検証
  - マージ履歴の記録
  - リダイレクト処理

#### 5.4 ラベルマージ画面（Frontend）
- [ ] /labels/merge ページ
- [ ] マージ元ラベル選択
- [ ] マージ先選択
  - 既存ラベルへのマージ
  - 新規ラベル作成
- [ ] 影響確認表示
- [ ] マージ実行・確認

#### 5.5 リダイレクト処理
- [ ] マージ済みタグへのアクセス処理（Backend）
  - 307 Temporary Redirect
  - リダイレクトチェーン対応
- [ ] マージ済みラベルへのアクセス処理（Backend）
- [ ] 削除済みリソースへの404処理

**成果物**:
- タグマージ機能
- ラベルマージ機能
- リダイレクト処理

**所要期間**: 2週間

---

### Phase 6: TODO拡張機能（Week 14-15）

**目的**: TODOコメント機能と検索機能の強化

#### 6.1 TODOコメント機能（Backend）
- [ ] POST /api/todos/:ulid/comments（コメント作成）
- [ ] GET /api/todos/:ulid/comments（コメント一覧取得）
- [ ] PATCH /api/comments/:ulid（コメント更新）
- [ ] DELETE /api/comments/:ulid（コメント削除）
- [ ] Markdown対応

#### 6.2 TODOコメントUI（Frontend）
- [ ] コメント一覧表示
- [ ] コメント入力フォーム
- [ ] Markdownエディタ
- [ ] コメント編集・削除

#### 6.3 TODO検索機能強化
- [ ] 全文検索（件名・内容）
- [ ] 複数タグのOR検索
- [ ] 期限による検索
- [ ] 完了/未完了フィルタ
- [ ] 検索条件の保存

**成果物**:
- TODOコメント機能
- 高度な検索機能

**所要期間**: 2週間

---

### Phase 7: GitHub連携（Week 16-17）

**目的**: GitHubアカウントでのログイン・登録

#### 7.1 GitHub OAuth連携（Backend）
- [ ] OAuth設定
- [ ] GET /api/auth/github（GitHub認証開始）
- [ ] GET /api/auth/github/callback（コールバック処理）
- [ ] GitHubユーザー情報取得
- [ ] 既存ユーザーとの紐付け
- [ ] 新規ユーザー作成

#### 7.2 GitHub連携UI（Frontend）
- [ ] GitHubログインボタンの実装
- [ ] GitHub登録ボタンの実装
- [ ] OAuth フロー処理
- [ ] エラーハンドリング

**成果物**:
- GitHub連携機能

**所要期間**: 2週間

---

### Phase 8: UI/UX改善（Week 18-19）

**目的**: レスポンシブデザインとアクセシビリティの向上

#### 8.1 レスポンシブデザイン
- [ ] モバイル対応（767px以下）
- [ ] タブレット対応（768px-1023px）
- [ ] デスクトップ対応（1024px以上）
- [ ] 各画面のレイアウト調整

#### 8.2 アクセシビリティ
- [ ] キーボード操作対応
- [ ] ARIA属性の追加
- [ ] スクリーンリーダー対応
- [ ] フォーカス管理
- [ ] カラーコントラスト調整

#### 8.3 アニメーション・トランジション
- [ ] モーダルのアニメーション
- [ ] リスト項目の追加・削除アニメーション
- [ ] ローディング表示
- [ ] トースト通知

#### 8.4 エラーハンドリング改善
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] リトライ機能
- [ ] ネットワークエラー処理
- [ ] オフライン対応

**成果物**:
- レスポンシブ対応
- アクセシビリティ改善
- UX向上

**所要期間**: 2週間

---

### Phase 9: テスト・品質向上（Week 20-22）

**目的**: テストの追加と品質向上

#### 9.1 バックエンドテスト
- [ ] 単体テスト
  - バリデーション関数
  - ユーティリティ関数
  - ビジネスロジック
- [ ] 統合テスト
  - API エンドポイント
  - データベース操作
- [ ] テストカバレッジ目標: 70%以上

#### 9.2 フロントエンドテスト
- [ ] コンポーネント単体テスト（Jest + React Testing Library）
- [ ] フック単体テスト
- [ ] 統合テスト
- [ ] E2Eテスト（Playwright）
  - ログインフロー
  - TODO作成フロー
  - タグ・ラベル管理フロー
  - マージフロー

#### 9.3 パフォーマンス最適化
- [ ] データベースクエリ最適化
- [ ] インデックスの追加
- [ ] N+1問題の解消
- [ ] フロントエンドバンドルサイズ削減
- [ ] 画像最適化
- [ ] キャッシュ戦略

#### 9.4 セキュリティ強化
- [ ] SQLインジェクション対策の確認
- [ ] XSS対策の確認
- [ ] CSRF対策の確認
- [ ] レート制限の実装
- [ ] セキュリティヘッダーの設定
- [ ] 依存パッケージの脆弱性チェック

**成果物**:
- テストスイート
- パフォーマンス最適化
- セキュリティ強化

**所要期間**: 3週間

---

### Phase 10: デプロイ準備（Week 23-24）

**目的**: 本番環境へのデプロイ準備

#### 10.1 本番環境構築
- [ ] サーバー構成の決定
- [ ] Docker本番イメージの作成
- [ ] 環境変数管理
- [ ] データベース本番設定
- [ ] HTTPS設定

#### 10.2 CI/CD パイプライン
- [ ] GitHub Actions設定
  - テスト実行
  - ビルド
  - デプロイ
- [ ] 自動テスト実行
- [ ] 自動デプロイ

#### 10.3 監視・ログ
- [ ] アプリケーションログ設定
- [ ] エラーログ収集
- [ ] パフォーマンス監視
- [ ] アラート設定

#### 10.4 ドキュメント整備
- [ ] README更新
- [ ] API ドキュメント
- [ ] デプロイ手順書
- [ ] 運用マニュアル

**成果物**:
- 本番環境
- CI/CDパイプライン
- 監視体制
- ドキュメント

**所要期間**: 2週間

---

## 実装の優先順位

### 必須機能（MVP）
1. ユーザー認証（Phase 1）
2. TODO CRUD（Phase 2）
3. タグ管理（Phase 3）
4. ホーム画面（Phase 2）

### 重要機能
5. ラベル機能（Phase 4）
6. マージ機能（Phase 5）
7. TODOコメント（Phase 6）

### 追加機能
8. GitHub連携（Phase 7）
9. 高度な検索（Phase 6）

### 品質向上
10. UI/UX改善（Phase 8）
11. テスト（Phase 9）
12. デプロイ準備（Phase 10）

## 依存関係

```
Phase 0 (環境構築)
  ↓
Phase 1 (認証) ←────────────────┐
  ↓                            │
Phase 2 (TODO基本) ←──────┐    │
  ↓                       │    │
Phase 3 (タグ管理)         │    │
  ↓                       │    │
Phase 4 (ラベル) ──────────┤    │
  ↓                       │    │
Phase 5 (マージ)            │    │
  ↓                       │    │
Phase 6 (TODO拡張) ─────────┤    │
  ↓                            │
Phase 7 (GitHub連携) ──────────┘
  ↓
Phase 8 (UI/UX改善)
  ↓
Phase 9 (テスト)
  ↓
Phase 10 (デプロイ)
```

## リスクと対応策

### リスク1: Common Lisp開発経験の不足
**影響度**: 高
**対応策**:
- clailsのドキュメント・サンプルコードの参照
- 段階的な実装とテスト
- 必要に応じて他のCommon Lispフレームワークの検討

### リスク2: ULID実装の複雑さ
**影響度**: 中
**対応策**:
- 既存のULIDライブラリの利用
- 必要に応じてUUID+タイムスタンプで代替

### リスク3: マージ機能の複雑さ
**影響度**: 中
**対応策**:
- 十分なテストケースの作成
- リダイレクトチェーンのループ検出
- トランザクション処理の徹底

### リスク4: メール送信機能
**影響度**: 中
**対応策**:
- 開発環境ではメールをログ出力
- メール送信サービス（SendGrid等）の利用検討

### リスク5: スケジュール遅延
**影響度**: 中
**対応策**:
- MVP（Phase 1-3）に集中
- 追加機能は後回し
- 定期的な進捗確認

## 成功基準

### MVP（最小実行可能製品）
- [ ] ユーザー登録・ログインができる
- [ ] TODOの作成・編集・削除・完了ができる
- [ ] タグを使ったTODO管理ができる
- [ ] タグの作成・編集・削除ができる
- [ ] タグでTODOを検索できる

### フル機能
- [ ] ラベルを使った複数タグの管理ができる
- [ ] タグ・ラベルのマージができる
- [ ] TODOにコメントを追加できる
- [ ] GitHubアカウントでログインできる
- [ ] モバイル・タブレットで快適に使える

### 品質
- [ ] テストカバレッジ70%以上
- [ ] ページ読み込み時間 2秒以内
- [ ] アクセシビリティ WCAG 2.1 AA準拠
- [ ] セキュリティ脆弱性なし

## マイルストーン

| マイルストーン | 期間 | 主要成果物 |
|--------------|------|-----------|
| M0: 環境構築完了 | Week 2 | 開発環境、DBスキーマ |
| M1: MVP完成 | Week 9 | 認証、TODO、タグ管理 |
| M2: ラベル機能完成 | Week 11 | ラベル管理 |
| M3: マージ機能完成 | Week 13 | タグ・ラベルマージ |
| M4: 拡張機能完成 | Week 17 | コメント、GitHub連携 |
| M5: 品質向上完了 | Week 22 | テスト、最適化 |
| M6: リリース準備完了 | Week 24 | 本番環境、CI/CD |

## 開発体制

### 推奨チーム構成
- バックエンド開発者: 1名
- フロントエンド開発者: 1名
- フルスタック開発者: 1名（両方担当）

### 開発サイクル
- **スプリント期間**: 2週間
- **デイリースタンドアップ**: 毎日15分
- **スプリントレビュー**: 2週間ごと
- **レトロスペクティブ**: 2週間ごと

## 次のステップ

1. **Phase 0を開始**: 環境構築・基盤整備
2. **タスクの詳細化**: 各フェーズのタスクをより細かく分解
3. **Issue作成**: GitHub Issuesにタスクを登録
4. **実装開始**: Phase 0.1（Docker環境構築）から着手

## 関連ドキュメント

- プロジェクト憲章: `constitution.md`
- データベーススキーマ: `database-schema-spec.md`
- API エラーレスポンス: `api-error-response-spec.md`
- 各種画面仕様: `*-spec.md`

---

**Version**: 1.1.0
**Created**: 2026-01-11
**Last Updated**: 2026-01-11
