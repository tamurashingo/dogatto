# タグ管理画面仕様

## 概要

タグの一覧表示、検索、作成、編集、削除、マージを行う管理画面。タグに色を設定してTODO一覧で視覚的に区別できるようにする。

## URL

- エンドポイント: `/tags`
- アクセス制御: ログイン済みユーザーのみ

## 画面構成

### レイアウト

```
+--------------------------------------------------+
| DOGATTO                    [ユーザーメニュー]     |
+--------------------------------------------------+
| タグ管理                                          |
+--------------------------------------------------+
| [検索: ___________] [🔍]            [+ 新規作成]  |
+--------------------------------------------------+
| 全タグ: 25件 | 使用中: 20件 | 未使用: 5件         |
+--------------------------------------------------+
| タグ名 ▲     | 色      | TODO数 | 更新日 | 操作 |
|-------------|--------|--------|--------|------|
| [DAILY]     | 🔵     | 15件   | 1/10   | ... |
| [MORNING]   | 🟠     | 8件    | 1/9    | ... |
| [WORKOUT]   | 🟢     | 12件   | 1/8    | ... |
| [PROJECT-A] | 🟣     | 3件    | 1/7    | ... |
| (未使用)    | ⚪     | 0件    | 1/6    | ... |
+--------------------------------------------------+
| ページネーション: < 1 2 3 ... 5 >                |
+--------------------------------------------------+
```

## 機能

### 1. タグ一覧表示

**表示内容:**
- タグ名
- タグの色（バッジ表示）
- TODO数（そのタグを使用しているTODO数）
- 最終更新日
- 操作ボタン（編集、削除）

**ソート:**
- タグ名（昇順/降順）
- TODO数（昇順/降順）
- 更新日（昇順/降順）

**フィルタ:**
- すべてのタグ
- 使用中のタグ（TODO数 > 0）
- 未使用のタグ（TODO数 = 0）

**ページネーション:**
- 20件/ページ
- ページ番号表示
- 前へ/次へボタン

### 2. タグ検索

**検索方法:**
- タグ名での前方一致検索
- リアルタイム検索（入力中にフィルタ）
- 大文字小文字を区別しない

**検索UI:**
```
+--------------------------------------------------+
| [検索: morning_______________] [🔍] [×クリア]     |
+--------------------------------------------------+
| 検索結果: 2件                                    |
| [MORNING]  🟠  8件   1/9                        |
| [MORNING-ROUTINE] 🔵 3件 1/8                    |
+--------------------------------------------------+
```

**検索実装:**
- Debounce: 300ms
- 最小文字数: 1文字
- 検索結果のハイライト表示

### 3. タグ新規登録

**トリガー:**
- 「+ 新規作成」ボタンをクリック

**表示形式:**
- モーダルダイアログ

**入力項目:**
```
+--------------------------------------------------+
| タグの作成                                [×]     |
+--------------------------------------------------+
| タグ名 *                                         |
| [_____________________________]                  |
| ※ 大文字で保存されます                           |
|                                                  |
| 色の選択                                         |
| [🔵] [🟢] [🟠] [🟣] [🔴] [🟡] [⚫] [⚪]          |
| または カスタムカラー: [#______] [🎨]            |
|                                                  |
| プレビュー:                                      |
| [EXAMPLE-TAG]                                    |
|                                                  |
|                         [キャンセル] [作成]       |
+--------------------------------------------------+
```

**バリデーション:**
- タグ名: 必須、1-100文字
- タグ名: 英数字、ハイフン、アンダースコア
- タグ名: 重複チェック（既存タグと比較）
- 色: HEXカラーコード形式（#RRGGBB）

**プリセットカラー:**
```javascript
const PRESET_COLORS = [
  { name: 'Blue', code: '#3B82F6' },      // 青
  { name: 'Green', code: '#10B981' },     // 緑
  { name: 'Orange', code: '#F97316' },    // オレンジ
  { name: 'Purple', code: '#8B5CF6' },    // 紫
  { name: 'Red', code: '#EF4444' },       // 赤
  { name: 'Yellow', code: '#F59E0B' },    // 黄
  { name: 'Pink', code: '#EC4899' },      // ピンク
  { name: 'Indigo', code: '#6366F1' },    // インディゴ
  { name: 'Teal', code: '#14B8A6' },      // ティール
  { name: 'Lime', code: '#84CC16' },      // ライム
  { name: 'Cyan', code: '#06B6D4' },      // シアン
  { name: 'Gray', code: '#6B7280' }       // グレー
];
```

**動作:**
1. タグ名を入力（自動的に大文字変換）
2. 色を選択（プリセットまたはカスタム）
3. プレビューで確認
4. 「作成」ボタンをクリック
5. API呼び出し
6. 成功時: モーダルを閉じ、一覧に追加、トースト通知
7. 失敗時: エラーメッセージ表示

### 4. タグ編集

**トリガー:**
- 操作メニュー（...）→「編集」をクリック
- タグ行をダブルクリック

**表示形式:**
- モーダルダイアログ

**入力項目:**
```
+--------------------------------------------------+
| タグの編集                                [×]     |
+--------------------------------------------------+
| タグ名 *                                         |
| [DAILY_____________________]                     |
| ※ 大文字で保存されます                           |
| ⚠ タグ名を変更すると、すべてのTODOに反映されます  |
|                                                  |
| 色の選択                                         |
| [🔵] [🟢] [🟠] [🟣] [🔴] [🟡] [⚫] [⚪]          |
| または カスタムカラー: [#3B82F6] [🎨]            |
|                                                  |
| 使用状況:                                        |
| このタグを使用しているTODO: 15件                 |
|                                                  |
| プレビュー:                                      |
| [DAILY]                                          |
|                                                  |
|                         [キャンセル] [更新]       |
+--------------------------------------------------+
```

**バリデーション:**
- タグ名変更時の重複チェック
- 使用中のタグの名前変更時は確認ダイアログ

**確認ダイアログ（名前変更時）:**
```
+--------------------------------------------------+
| タグ名を変更しますか？                            |
+--------------------------------------------------+
| タグ名を "DAILY" から "EVERYDAY" に変更します。  |
|                                                  |
| この変更は以下に影響します:                       |
| • 15件のTODO                                     |
| • 3件のラベル                                    |
|                                                  |
| この操作は取り消せません。                        |
|                                                  |
|                         [キャンセル] [変更]       |
+--------------------------------------------------+
```

**動作:**
1. タグ情報を取得してフォームに表示
2. タグ名または色を変更
3. 「更新」ボタンをクリック
4. 名前変更の場合は確認ダイアログ表示
5. API呼び出し
6. 成功時: モーダルを閉じ、一覧を更新、トースト通知
7. 失敗時: エラーメッセージ表示

### 5. タグマージ

**トリガー:**
- 画面上部の「マージ」ボタンをクリック
- または操作メニュー（...）→「マージ」をクリック

**表示形式:**
- 専用のマージ画面へ遷移（`/tags/merge`）
- または大きなモーダルダイアログ

**マージUI（簡易版）:**
```
+--------------------------------------------------+
| タグのマージ                              [×]     |
+--------------------------------------------------+
| マージ元タグを選択:                              |
| [MORNIG ▼]                                       |
|                                                  |
| マージ先を選択:                                  |
| ( ) 既存のタグにマージ                            |
|     [MORNING ▼]                                  |
| (•) 新しいタグを作成                              |
|     タグ名: [NEW-TAG___________]                 |
|     色: [🔵]                                     |
|                                                  |
| 影響を受けるTODO: 5件                            |
| 影響を受けるラベル: 2件                          |
|                                                  |
|                         [キャンセル] [マージ]     |
+--------------------------------------------------+
```

**詳細:**
- タグマージ仕様（`tag-merge-spec.md`）を参照

### 6. タグ削除

**トリガー:**
- 操作メニュー（...）→「削除」をクリック

**確認ダイアログ:**
```
+--------------------------------------------------+
| タグを削除しますか？                              |
+--------------------------------------------------+
| タグ "DAILY" を削除します。                       |
|                                                  |
| このタグを使用しているTODO: 15件                 |
| このタグを含むラベル: 3件                        |
|                                                  |
| ⚠ 削除すると以下の影響があります:                |
| • TODOからこのタグが削除されます                 |
| • ラベルからこのタグが削除されます                |
|                                                  |
| この操作は取り消せません。                        |
| 代わりにマージを検討してください。                |
|                                                  |
|                         [キャンセル] [削除]       |
+--------------------------------------------------+
```

**削除種類:**

1. **未使用タグの削除（論理削除）**
   - TODO数 = 0 のタグ
   - `deleted_at` に日時を設定
   - 確認ダイアログは簡易版

2. **使用中タグの削除（警告付き）**
   - TODO数 > 0 のタグ
   - 影響範囲を表示
   - マージ推奨メッセージ
   - 削除理由の入力（オプション）

**動作:**
1. 削除ボタンをクリック
2. 使用状況を取得
3. 確認ダイアログ表示
4. 「削除」ボタンをクリック
5. API呼び出し
6. 成功時:
   - 一覧から削除
   - トースト通知: "タグを削除しました"
7. 失敗時:
   - エラーダイアログ表示

## 操作メニュー

**表示:**
- 各タグ行の右端に「...」アイコン
- クリックでドロップダウンメニュー表示

**メニュー項目:**
```
┌─────────────────┐
│ 📝 編集         │
│ 🔀 マージ       │
│ 🗑️ 削除         │
└─────────────────┘
```

**キーボードショートカット:**
- `e`: 編集
- `m`: マージ
- `Delete`: 削除

## API仕様

### 1. タグ一覧取得

**エンドポイント:** `GET /api/tags`

**クエリパラメータ:**
- `page`: ページ番号（デフォルト: 1）
- `per_page`: 1ページあたりの件数（デフォルト: 20、最大: 100）
- `sort`: ソート項目（name, todo_count, updated_at）
- `order`: ソート順（asc, desc）
- `filter`: フィルタ（all, used, unused）
- `q`: 検索キーワード

**レスポンス:**
```json
{
  "status": "success",
  "data": {
    "tags": [
      {
        "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
        "name": "DAILY",
        "color": "#3B82F6",
        "todo_count": 15,
        "label_count": 3,
        "is_merged": false,
        "created_at": "2026-01-01T00:00:00Z",
        "updated_at": "2026-01-10T00:00:00Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "per_page": 20,
      "total_pages": 5,
      "total_count": 95
    },
    "stats": {
      "total_tags": 95,
      "used_tags": 80,
      "unused_tags": 15
    }
  }
}
```

### 2. タグ作成

**エンドポイント:** `POST /api/tags`

**リクエスト:**
```json
{
  "name": "NEW-TAG",
  "color": "#3B82F6"
}
```

**レスポンス:**
```json
{
  "status": "success",
  "data": {
    "tag": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "name": "NEW-TAG",
      "color": "#3B82F6",
      "todo_count": 0,
      "label_count": 0,
      "created_at": "2026-01-11T00:00:00Z",
      "updated_at": "2026-01-11T00:00:00Z"
    }
  }
}
```

**エラーレスポンス:**
```json
{
  "status": "error",
  "error": {
    "code": "DUPLICATE_TAG",
    "message": "このタグは既に存在します",
    "details": {
      "name": ["タグ名 'NEW-TAG' は既に使用されています"]
    }
  }
}
```

### 3. タグ更新

**エンドポイント:** `PATCH /api/tags/{ulid}`

**リクエスト:**
```json
{
  "name": "UPDATED-TAG",
  "color": "#10B981"
}
```

**レスポンス:**
```json
{
  "status": "success",
  "data": {
    "tag": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "name": "UPDATED-TAG",
      "color": "#10B981",
      "todo_count": 15,
      "label_count": 3,
      "updated_at": "2026-01-11T01:00:00Z"
    }
  }
}
```

### 4. タグ削除

**エンドポイント:** `DELETE /api/tags/{ulid}`

**レスポンス:**
```json
{
  "status": "success",
  "message": "タグを削除しました",
  "data": {
    "deleted_todo_tags": 15,
    "deleted_label_tags": 3
  }
}
```

### 5. タグ使用状況取得

**エンドポイント:** `GET /api/tags/{ulid}/usage`

**レスポンス:**
```json
{
  "status": "success",
  "data": {
    "tag": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "name": "DAILY",
      "color": "#3B82F6"
    },
    "usage": {
      "todo_count": 15,
      "label_count": 3,
      "todos": [
        {
          "ulid": "01BRZ3NDEKTSV4RRFFQ69G5FAV",
          "title": "体重測定"
        }
      ],
      "labels": [
        {
          "ulid": "01CRZ3NDEKTSV4RRFFQ69G5FAV",
          "name": "朝活"
        }
      ]
    }
  }
}
```

## バリデーション

### タグ名

**クライアント側:**
- 必須チェック
- 文字数チェック（1-100文字）
- 文字種チェック（英数字、ハイフン、アンダースコア）
- 自動大文字変換

**サーバー側:**
- 必須チェック
- 文字数チェック
- 文字種チェック
- 重複チェック（ユーザー内）
- 大文字変換

**エラーメッセージ:**
- "タグ名を入力してください"
- "タグ名は100文字以内で入力してください"
- "タグ名は英数字、ハイフン、アンダースコアのみ使用できます"
- "このタグは既に存在します"

### 色

**形式:**
- HEXカラーコード（#RRGGBB）
- 正規表現: `^#[0-9A-Fa-f]{6}$`

**デフォルト値:**
- 色未指定時: `#6B7280`（グレー）

## UI/UX要件

### 1. レスポンシブデザイン

**デスクトップ（1024px以上）:**
- テーブル表示
- すべてのカラムを表示
- 操作メニュー: ドロップダウン

**タブレット（768px - 1023px）:**
- テーブル表示
- 一部カラムを非表示（更新日など）
- 操作メニュー: ドロップダウン

**モバイル（767px以下）:**
- カード表示
```
┌─────────────────────────────┐
│ [DAILY] 🔵                  │
│ 15件のTODO                  │
│ 更新: 1/10                  │
│ [編集] [削除]               │
└─────────────────────────────┘
```

### 2. アクセシビリティ

**キーボード操作:**
- `Tab`: 次の要素へ移動
- `Shift + Tab`: 前の要素へ移動
- `Enter`: ボタンのクリック、リンクの遷移
- `Space`: チェックボックスのトグル
- `↑↓`: リスト内の移動
- `e`: 選択中のタグを編集
- `Delete`: 選択中のタグを削除

**ARIA属性:**
- `role="table"`: テーブル
- `role="button"`: ボタン
- `aria-label`: ボタンのラベル
- `aria-sort`: ソート状態
- `aria-live`: 動的な更新通知

**スクリーンリーダー対応:**
- タグ名、TODO数、操作の読み上げ
- 検索結果の件数読み上げ
- エラーメッセージの読み上げ

### 3. パフォーマンス

**検索:**
- Debounce: 300ms
- キャンセル処理（前回のリクエストをキャンセル）

**一覧表示:**
- 仮想スクロール（100件以上の場合）
- ページネーション

**カラーピッカー:**
- 遅延ロード

### 4. アニメーション

**タグ追加:**
- リストの先頭に追加
- フェードイン + スライドダウン（300ms）

**タグ削除:**
- フェードアウト + スライドアップ（300ms）
- リストの高さを調整

**モーダル:**
- 背景: フェードイン（200ms）
- コンテンツ: スライドアップ（300ms）

## エラーハンドリング

### 1. タグ作成エラー

**重複エラー:**
- エラーメッセージ: "このタグは既に存在します"
- 既存タグへのリンク表示

**ネットワークエラー:**
- エラーダイアログ表示
- リトライボタン

### 2. タグ削除エラー

**依存関係エラー:**
- エラーメッセージ: "このタグは使用中のため削除できません"
- マージを推奨

**権限エラー:**
- エラーメッセージ: "このタグを削除する権限がありません"

### 3. 検索エラー

**タイムアウト:**
- エラーメッセージ: "検索がタイムアウトしました"
- リトライボタン

## セキュリティ要件

### 認証・認可

- ユーザー認証必須
- 自分のタグのみ操作可能
- 他ユーザーのタグは参照不可

### CSRF対策

- すべてのPOST/PATCH/DELETE にCSRFトークン

### XSS対策

- タグ名のエスケープ
- カラーコードのバリデーション

### レート制限

- タグ作成: 10回/分
- タグ更新: 20回/分
- タグ削除: 5回/分

## 実装順序

### フェーズ1: 基本機能
1. タグ一覧表示
2. ページネーション
3. ソート機能

### フェーズ2: CRUD操作
1. タグ作成
2. タグ編集
3. タグ削除

### フェーズ3: 検索・フィルタ
1. タグ検索
2. フィルタ機能
3. リアルタイム検索

### フェーズ4: 高度な機能
1. カラーピッカー
2. プレビュー機能
3. 使用状況表示

### フェーズ5: マージ機能
1. マージ画面への遷移
2. マージ機能の統合

## テスト要件

### 1. 単体テスト
- タグ名の大文字変換
- カラーコードのバリデーション
- 検索フィルタリングロジック

### 2. 統合テスト
- タグ一覧API連携
- タグ作成API連携
- タグ更新API連携
- タグ削除API連携

### 3. E2Eテスト
- タグ作成フロー
- タグ編集フロー
- タグ削除フロー
- タグ検索フロー
- マージフロー

### 4. アクセシビリティテスト
- キーボード操作
- スクリーンリーダー
- WCAG 2.1 AA準拠

## データ表示例

### タグ一覧のサンプルデータ

```
┌─────────────┬────────┬────────┬─────────┬────────┐
│ タグ名      │ 色     │ TODO数 │ 更新日  │ 操作   │
├─────────────┼────────┼────────┼─────────┼────────┤
│ [DAILY]     │ 🔵     │ 15件   │ 1/10    │ ...    │
│ [MORNING]   │ 🟠     │ 8件    │ 1/9     │ ...    │
│ [WORKOUT]   │ 🟢     │ 12件   │ 1/8     │ ...    │
│ [PROJECT-A] │ 🟣     │ 3件    │ 1/7     │ ...    │
│ [HEALTH]    │ 🔴     │ 7件    │ 1/6     │ ...    │
│ [STUDY]     │ 🟡     │ 5件    │ 1/5     │ ...    │
│ [OLD-TAG]   │ ⚪     │ 0件    │ 12/1    │ ...    │
└─────────────┴────────┴────────┴─────────┴────────┘
```

## 将来の拡張

- タグのグループ化
- タグの並び替え（ドラッグ&ドロップ）
- タグのお気に入り機能
- タグの使用頻度グラフ
- タグのエクスポート/インポート
- タグの一括操作（一括削除、一括マージ）
- タグの履歴表示
- タグのアイコン設定
- タグの説明文
- タグの親子関係

## 関連仕様

- プロジェクト憲章: `constitution.md`
- タグマージ仕様: `tag-merge-spec.md`
- データベーススキーマ: `database-schema-spec.md`
- ホーム画面仕様: `home-spec.md`
- TODO登録・編集コンポーネント仕様: `todo-form-component-spec.md`

---

**Version**: 1.0.0
**Created**: 2026-01-11
**Last Updated**: 2026-01-11
