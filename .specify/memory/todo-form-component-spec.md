# TODO登録・編集コンポーネント仕様

## 概要

TODOの新規登録および既存TODOの編集を行うコンポーネント。モーダルまたはインラインフォームとして表示され、タグ/ラベルの自動補完機能を持つ。

## 使用場所

- ホーム画面のTODO登録エリア
- TODO一覧の編集ボタン
- TODO詳細画面の編集ボタン
- フローティングボタンからのクイック追加

## 表示モード

### 1. 新規登録モード

**表示項目:**
- 件名（必須）
- 内容（任意）
- 期限（任意）
- タグ/ラベル（任意）

### 2. 編集モード

**表示項目:**
- No（表示のみ、編集不可）
- 件名（必須）
- 内容（任意）
- 期限（任意）
- タグ/ラベル（任意）

## フォーム項目詳細

### 3.1 No（編集時のみ表示）

**表示形式:**
- ラベル: "No"
- 値: TODO の ULID
- 表示位置: フォーム最上部
- スタイル: 小さめのグレー文字
- コピー可能（クリックでクリップボードにコピー）

### 3.2 件名

**入力仕様:**
- ラベル: "件名" / "Title"
- 入力タイプ: text
- 必須項目
- 最大長: 255文字
- プレースホルダー: "TODOのタイトルを入力..."
- バリデーション:
  - 空文字不可
  - 最大長超過チェック

### 3.3 内容

**入力仕様:**
- ラベル: "内容" / "Description"
- 入力タイプ: textarea
- 任意項目
- 最大長: 10,000文字
- プレースホルダー: "詳細を入力..."
- 高さ: 最小3行、最大10行（自動拡張）
- マークダウンサポート（将来実装）

### 3.4 期限

**入力仕様:**
- ラベル: "期限" / "Due Date"
- 入力タイプ: date picker
- 任意項目
- 形式: YYYY-MM-DD
- 最小日: 今日
- カレンダーピッカー表示
- クリアボタン付き
- キーボードショートカット:
  - `t`: 今日
  - `w`: 1週間後
  - `m`: 1ヶ月後

### 3.5 タグ/ラベル入力エリア

**表示形式:**
- ラベル: "タグ/ラベル" / "Tags/Labels"
- 入力エリア: タグトークン入力フィールド
- 選択済みタグの表示: バッジ形式（entity）
- 入力フィールド: インライン入力

**選択済みタグの表示:**
```
+------------------------------------------+
| [DAILY ×] [WORKOUT ×] [MONDAY ×] |_____|  ← 入力カーソル
+------------------------------------------+
```

**タグ entity の仕様:**
- 背景色: タグに設定された色またはデフォルト色
- テキスト: タグ名（大文字）
- 削除ボタン: × アイコン
- ホバー時: 背景色を濃く
- 削除方法:
  - × ボタンをクリック
  - タグを選択してBackspace/Delete キー
  - タグを選択してDelete キー

**入力フィールドの動作:**
- プレースホルダー: "タグまたはラベルを入力..."
- 2文字以上入力で自動補完を開始
- フォーカス時: すべてのタグ/ラベルをサジェスト表示（オプション）

## タグ/ラベル入力の詳細仕様

### 4.1 検索とサジェスト

**トリガー条件:**
- 2文字以上の入力
- 入力内容の変更（debounce: 200ms）

**検索対象:**
- ユーザーが登録したすべてのタグ
- ユーザーが登録したすべてのラベル

**検索ロジック:**
- 前方一致検索
- Case-insensitive（大文字小文字を区別しない）
- 入力: "dai" → マッチ: "DAILY", "DAIRY"

**サジェスト表示:**
```
+------------------------------------------+
| [WORKOUT ×] dai|                         |
+------------------------------------------+
| ▼ タグ                                   |
| > DAILY                           (タグ) |
|   DAIRY                           (タグ) |
| ▼ ラベル                                 |
|   DAILY (DAILY, MONDAY)         (ラベル) |
+------------------------------------------+
```

**サジェストリストの表示内容:**
- タグセクション
  - タグ名
  - "(タグ)" 表示
- ラベルセクション
  - ラベル名
  - 所属タグの表示（括弧内）
  - "(ラベル)" 表示

**表示件数:**
- タグ: 最大10件
- ラベル: 最大5件
- 合計: 最大15件

### 4.2 キーボード操作

**ナビゲーション:**
- `↑` (上矢印): 前の候補を選択
- `↓` (下矢印): 次の候補を選択
- `Enter`: 選択中の候補を確定
  - 候補未選択時: 新規タグとして登録
  - IME変換中のEnterは無視（compositionend イベントで判定）
- `Space` (スペース): 選択中の候補を確定
  - 候補未選択時: 新規タグとして登録
  - IME変換中のSpaceは無視
- `Escape`: サジェストを閉じる
- `Backspace`: 
  - 入力フィールドが空の場合: 最後のタグを削除
  - 入力フィールドに文字がある場合: 通常の削除動作
- `Tab`: 選択中の候補を確定（次のフィールドへは移動しない）

**マウス操作:**
- 候補をクリック: 候補を確定
- 候補をホバー: 背景色変更

### 4.3 タグ/ラベル選択時の動作

**タグ選択時:**
1. 選択されたタグをタグリストに追加
2. 入力フィールドをクリア
3. サジェストを閉じる
4. 重複チェック（既に選択されている場合は追加しない）

**ラベル選択時:**
1. ラベルに所属するすべてのタグを展開
2. 展開されたタグをタグリストに追加
3. 入力フィールドをクリア
4. サジェストを閉じる
5. 重複チェック（既に選択されているタグは追加しない）

**例:**
- ラベル "WORKOUT" を選択
- ラベルに所属するタグ: "WORKOUT", "TUESDAY"
- 結果: `[WORKOUT ×] [TUESDAY ×]` が追加される

### 4.4 新規タグの作成

**トリガー条件:**
- サジェスト未選択の状態で Enter キーまたは Space キー
- IMEの変換確定後（compositionend イベント後）

**新規タグの仕様:**
- タグ名: 入力された文字列を大文字に変換
- 大文字変換: 全角英字も半角大文字に変換
  - 入力: "daily" → タグ: "DAILY"
  - 入力: "ｄａｉｌｙ" → タグ: "DAILY"
  - 入力: "Daily" → タグ: "DAILY"

**既存タグとの重複チェック:**
1. 入力された文字列を大文字に変換
2. 既存タグと完全一致するかチェック（case-insensitive）
3. 一致する場合: 既存タグを使用
4. 一致しない場合: 新規タグとして作成

**新規タグの保存タイミング:**
- TODO保存時に一緒に保存
- サーバー側で重複チェック再実施

### 4.5 IME（日本語入力）対応

**IME状態の判定:**
- `compositionstart`: IME変換開始
- `compositionupdate`: IME変換中
- `compositionend`: IME変換確定

**Enter/Space キーの処理:**
```javascript
let isComposing = false;

element.addEventListener('compositionstart', () => {
  isComposing = true;
});

element.addEventListener('compositionend', () => {
  isComposing = false;
});

element.addEventListener('keydown', (e) => {
  if ((e.key === 'Enter' || e.key === ' ') && !isComposing) {
    // タグ確定処理
    e.preventDefault(); // Spaceの場合、スペース入力を防ぐ
  }
});
```

**注意点:**
- IME変換中のEnter/Spaceは無視
- compositionend 後のEnter/Spaceでタグ確定
- Space キーの場合は preventDefault() でスペース入力を防ぐ
- ブラウザによって動作が異なる可能性があるため、複数ブラウザでテスト必須

## アクションボタン

### 5.1 保存ボタン

**表示:**
- テキスト: "保存" / "Save"（新規登録時）
- テキスト: "更新" / "Update"（編集時）
- 配置: フォーム下部右側
- スタイル: プライマリボタン

**動作:**
- クリック時: フォームバリデーション実行
- バリデーション成功: API呼び出し
- バリデーション失敗: エラーメッセージ表示
- 処理中: ローディング状態表示、二重送信防止

**キーボードショートカット:**
- `Ctrl + Enter` (Windows/Linux)
- `Cmd + Enter` (Mac)

### 5.2 キャンセルボタン

**表示:**
- テキスト: "キャンセル" / "Cancel"
- 配置: フォーム下部左側
- スタイル: セカンダリボタン

**動作:**
- クリック時: 確認ダイアログ表示（変更がある場合のみ）
- 確認ダイアログ:
  - メッセージ: "変更を破棄してもよろしいですか？"
  - ボタン: "破棄", "キャンセル"
- フォームを閉じる
- 入力内容をクリア

**キーボードショートカット:**
- `Escape`

## API仕様

### 6.1 タグ/ラベル検索

**エンドポイント:** `GET /api/tags/search`

**クエリパラメータ:**
- `q`: 検索キーワード（2文字以上）
- `limit`: 取得件数（デフォルト: 15）

**レスポンス:**
```json
{
  "status": "success",
  "data": {
    "tags": [
      {
        "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
        "name": "DAILY",
        "color": "#3B82F6",
        "type": "tag"
      }
    ],
    "labels": [
      {
        "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
        "name": "DAILY",
        "type": "label",
        "tags": [
          {
            "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
            "name": "DAILY"
          },
          {
            "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
            "name": "MONDAY"
          }
        ]
      }
    ]
  }
}
```

### 6.2 TODO作成

**エンドポイント:** `POST /api/todos`

**リクエスト:**
```json
{
  "title": "体重測定",
  "description": "毎朝の体重を記録する",
  "due_date": "2026-01-15",
  "tag_names": ["DAILY", "HEALTH"],
  "new_tags": ["HEALTH"]
}
```

**レスポンス:**
```json
{
  "status": "success",
  "data": {
    "todo": {
      "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
      "title": "体重測定",
      "description": "毎朝の体重を記録する",
      "status": "active",
      "due_date": "2026-01-15",
      "tags": [
        {
          "ulid": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
          "name": "DAILY",
          "color": "#3B82F6"
        },
        {
          "ulid": "01BRZ3NDEKTSV4RRFFQ69G5FAV",
          "name": "HEALTH",
          "color": "#10B981"
        }
      ],
      "created_at": "2026-01-11T00:00:00Z",
      "updated_at": "2026-01-11T00:00:00Z"
    }
  }
}
```

### 6.3 TODO更新

**エンドポイント:** `PATCH /api/todos/{ulid}`

**リクエスト:**
```json
{
  "title": "体重測定（更新）",
  "description": "毎朝の体重を記録する",
  "due_date": "2026-01-16",
  "tag_names": ["DAILY", "HEALTH", "MORNING"],
  "new_tags": ["MORNING"]
}
```

**レスポンス:**
- TODO作成と同じ形式

## バリデーション

### 7.1 クライアント側バリデーション

**件名:**
- 必須チェック
- 最大長チェック（255文字）
- エラーメッセージ: "件名を入力してください" / "件名は255文字以内で入力してください"

**内容:**
- 最大長チェック（10,000文字）
- エラーメッセージ: "内容は10,000文字以内で入力してください"

**期限:**
- 日付形式チェック
- 過去日付の警告（エラーではない）
- エラーメッセージ: "有効な日付を入力してください"

**タグ:**
- タグ名の最大長チェック（100文字）
- エラーメッセージ: "タグ名は100文字以内で入力してください"

### 7.2 サーバー側バリデーション

**件名:**
- 必須チェック
- 最大長チェック
- XSSチェック

**タグ:**
- 大文字変換
- 重複チェック
- 最大長チェック

## UI/UX要件

### 8.1 レスポンシブデザイン

**デスクトップ（1024px以上）:**
- モーダル幅: 600px
- タグ入力エリア: 複数行表示可能

**タブレット（768px - 1023px）:**
- モーダル幅: 90%
- タグ入力エリア: 複数行表示可能

**モバイル（767px以下）:**
- フルスクリーンモーダル
- タグ入力エリア: 複数行表示
- サジェストリスト: 画面下部に固定

### 8.2 アクセシビリティ

**キーボード操作:**
- Tab: 次のフィールドへ移動
- Shift + Tab: 前のフィールドへ移動
- Enter: フォーム送信（タグ入力以外）
- Escape: モーダルを閉じる

**ARIA属性:**
- `role="combobox"`: タグ入力フィールド
- `aria-expanded`: サジェストの表示状態
- `aria-activedescendant`: 選択中の候補
- `role="option"`: サジェスト候補
- `aria-label`: 各フィールドのラベル

**スクリーンリーダー対応:**
- サジェスト候補数の読み上げ
- 選択中の候補の読み上げ
- タグ追加/削除の通知

### 8.3 パフォーマンス

**サジェスト検索:**
- Debounce: 200ms
- キャンセル処理: 前回のリクエストをキャンセル
- キャッシュ: 検索結果を30秒間キャッシュ

**レンダリング:**
- タグが多い場合の仮想スクロール（50件以上）
- サジェストリストの仮想スクロール（50件以上）

### 8.4 エラーハンドリング

**ネットワークエラー:**
- トースト通知で表示
- リトライボタン表示

**バリデーションエラー:**
- フィールド下にエラーメッセージ表示
- エラーフィールドにフォーカス

**サーバーエラー:**
- エラーダイアログ表示
- エラー内容を表示

## データモデル（再掲）

### 9.1 Tagsテーブル

```sql
CREATE TABLE tags (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  ulid CHAR(26) UNIQUE NOT NULL,
  user_id BIGINT NOT NULL,
  name VARCHAR(100) NOT NULL,
  color VARCHAR(7),
  merged_to_tag_id BIGINT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (merged_to_tag_id) REFERENCES tags(id) ON DELETE SET NULL,
  UNIQUE KEY uk_user_name (user_id, name),
  INDEX idx_ulid (ulid),
  INDEX idx_user_id (user_id),
  INDEX idx_name (name)
);
```

## 実装順序

### フェーズ1: 基本フォーム
1. フォームレイアウト作成
2. 件名、内容、期限の入力フィールド
3. 保存・キャンセルボタン
4. バリデーション

### フェーズ2: タグ入力（基本）
1. タグ表示（バッジ形式）
2. タグ削除機能
3. タグ入力フィールド
4. 新規タグ作成

### フェーズ3: タグ自動補完
1. サジェスト検索API連携
2. サジェストリスト表示
3. キーボードナビゲーション
4. タグ/ラベル選択

### フェーズ4: IME対応・UX改善
1. IME状態の判定
2. キーボードショートカット
3. レスポンシブデザイン
4. アクセシビリティ対応

## テスト要件

### 10.1 単体テスト
- タグ名の大文字変換
- タグ重複チェック
- バリデーションロジック
- IME状態判定

### 10.2 統合テスト
- タグ検索API連携
- TODO作成API連携
- TODO更新API連携
- ラベル展開機能

### 10.3 E2Eテスト
- TODO新規登録フロー
- TODO編集フロー
- タグ/ラベル選択フロー
- 新規タグ作成フロー
- キーボード操作
- IME入力

### 10.4 ブラウザ互換性テスト
- Chrome
- Firefox
- Safari
- Edge
- モバイルブラウザ（iOS Safari, Chrome for Android）

## 将来の拡張

- タグの色設定
- タグのグループ化
- タグの使用頻度に基づくサジェスト順序
- タグのエイリアス機能
- タグのお気に入り機能
- ドラッグ&ドロップでのタグ並び替え
- タグのインライン編集
- マークダウンエディタ統合
- 添付ファイル対応
- リッチテキストエディタ

## 関連仕様

- ホーム画面仕様: `home-spec.md`
- タグ管理画面仕様: `tags-spec.md` (今後作成)
- ラベル管理画面仕様: `labels-spec.md` (今後作成)

---

**Version**: 1.1.0
**Created**: 2026-01-11
**Last Updated**: 2026-01-11
